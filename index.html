<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>SunWin Bot D·ª± ƒêo√°n (API M·ªõi)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0; padding: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: white;
      height: 100vh;
      overflow: hidden;
    }

    /* H·ªôp nh·∫≠p key */
    #loginBox {
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0.45), rgba(0,0,0,0.85));
      z-index: 10000;
    }
    #loginPanel {
      background: rgba(0,0,0,0.6);
      padding: 28px 26px;
      border-radius: 16px;
      width: min(92vw, 360px);
      text-align: center;
      box-shadow: 0 0 30px rgba(0,255,255,0.35);
      border: 1px solid rgba(0,255,255,0.25);
      backdrop-filter: blur(6px);
      animation: glowBox 2s infinite alternate;
    }
    @keyframes glowBox {
      0% { box-shadow: 0 0 18px rgba(0,255,255,0.3); }
      100% { box-shadow: 0 0 34px rgba(0,255,255,0.75); }
    }

    /* √î nh·∫≠p key */
    #password {
      padding: 12px 14px;
      width: 100%;
      border-radius: 12px;
      font-size: 18px;
      text-align: center;
      color: #0ff;
      font-weight: 600;
      border: 2px solid transparent;
      background: rgba(0,0,0,0.35);
      border-image: linear-gradient(90deg, #00f5ff, #7b2fff) 1;
      box-shadow: inset 0 0 12px rgba(0,0,0,0.65);
      transition: all .25s;
    }
    #password:focus {
      outline: none;
      border-image: linear-gradient(270deg, #00f5ff, #7b2fff, #ff00ff) 1;
      box-shadow: 0 0 22px #00f5ff, 0 0 36px #7b2fff;
      animation: neonPulse 1.4s infinite alternate;
    }
    @keyframes neonPulse {
      from { box-shadow: 0 0 16px #00f5ff, 0 0 26px #7b2fff; }
      to   { box-shadow: 0 0 28px #ff00ff, 0 0 46px #00f5ff; }
    }

    .btn {
      padding: 11px 18px;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: .25s;
      width: 100%;
      margin-top: 10px;
    }
    .btn:hover { transform: translateY(-1px) scale(1.02); }

    #loginBtn { background: linear-gradient(90deg, #00c6ff, #0072ff); }
    #buyKeyBtn {
      background: linear-gradient(90deg, #ff0080, #ff8c00);
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 16px #ff0080;
    }
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 16px #ff0080; }
      50% { transform: scale(1.03); box-shadow: 0 0 28px #ff8c00; }
      100% { transform: scale(1); box-shadow: 0 0 16px #ff0080; }
    }

    #msg { min-height: 22px; margin: 6px 0 0; font-weight: 600; }

    /* Li√™n h·ªá admin khi nh·∫≠p sai */
    #adminContact {
      margin-top: 10px;
      font-size: 16px;
      font-weight: bold;
      display: none;
      animation: blinkText 1.2s infinite alternate;
    }
    #adminContact a {
      background: linear-gradient(90deg, #ff0000, #ff9900, #00ffea, #ff00ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 800;
      text-decoration: none;
      animation: gradientMove 3s infinite linear;
      background-size: 200% auto;
    }
    @keyframes blinkText { 0% { opacity: .35; } 100% { opacity: 1; } }
    @keyframes gradientMove { 0% { background-position: 0% 50%; } 100% { background-position: 200% 50%; } }

    /* Popup mua key */
    #popup {
      position: fixed; inset: 0; z-index: 10001;
      background: rgba(0,0,0,0.7);
      display: none; align-items: center; justify-content: center;
    }
    #popupContent {
      background: #111; color: #fff;
      padding: 18px; border-radius: 12px;
      width: min(92vw, 360px);
      box-shadow: 0 0 16px #ff7e5f;
      border: 1px solid rgba(255,126,95,0.35);
      text-align: center;
      position: relative;
    }
    #packageTable { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 15px; }
    #packageTable tr {
      cursor: pointer; transition: .25s; border: 2px solid transparent;
    }
    #packageTable tr:hover { background: rgba(0,255,200,.14); border: 2px solid #00ffd5; transform: scale(1.03); }
    #packageTable tr.active { background: rgba(255,255,255,.14); border: 2px solid #ff00ff; box-shadow: 0 0 14px #ff00ff inset; font-weight: 700; }

    #qrImage {
      border: 4px solid #00ffea;
      border-radius: 14px;
      box-shadow: 0 0 20px #00ffea;
      animation: qrGlow 2s infinite alternate;
      width: 240px; max-width: 80vw;
    }
    @keyframes qrGlow { from { box-shadow: 0 0 16px #00ffea; } to { box-shadow: 0 0 30px #ff00ff; } }

    #packageName {
      font-size: 18px; font-weight: 800; color: #00ffea;
      text-shadow: 0 0 8px #00fff2; margin: 8px 0 12px;
    }
    #paymentBox button {
      background: linear-gradient(90deg, #00ffea, #0077ff);
      color: #fff; font-weight: 800; padding: 10px 16px;
      border-radius: 10px; border: none; cursor: pointer; transition: .25s;
    }
    #paymentBox button:hover { transform: scale(1.06); background: linear-gradient(90deg, #0077ff, #00ffea); }

    /* Iframe n·ªÅn */
    #mainContent { display: none; height: 100vh; }
    iframe { width: 100vw; height: 100vh; border: none; }

    /* ROBOT n·ªïi */
    #robotContainer {
      position: fixed; left: 24px; top: 50%; transform: translateY(-50%);
      display: flex; gap: 10px; align-items: center; z-index: 9999;
      cursor: grab; user-select: none;
      padding: 15px 18px; border-radius: 20px;
      background: rgba(0,0,0,0.85);
      border: 2px solid rgba(255,255,255,0.15);
      box-shadow:
        0 0 0 3px rgba(0,255,255,0.6),
        0 0 25px rgba(0,255,255,0.4),
        inset 0 0 15px rgba(0,0,0,0.7);
      backdrop-filter: blur(10px);
      min-width: 320px;
      animation: robotGlow 3s ease-in-out infinite alternate;
    }
    @keyframes robotGlow {
      from {
        box-shadow: 0 0 0 3px rgba(0,255,255,0.4), 0 0 20px rgba(0,255,255,0.3), inset 0 0 15px rgba(0,0,0,0.7);
      }
      to {
        box-shadow: 0 0 0 3px rgba(255,0,128,0.6), 0 0 30px rgba(255,0,128,0.4), inset 0 0 15px rgba(0,0,0,0.7);
      }
    }
    #robotContainer:active { cursor: grabbing; }

    #robotIcon { width: 70px; height: 70px; flex: 0 0 auto; filter: drop-shadow(0 0 12px rgba(0,255,255,.5)); }
    #robotText { line-height: 1.4; flex: 1; }
    #robotText .title { font-weight: 800; margin-bottom: 8px; font-size: 16px; }
    #robotText .line { font-size: 14px; margin-bottom: 4px; }
    #robotText .strong { font-weight: 800; }

    /* D·ª± ƒëo√°n n·ªïi b·∫≠t */
    .prediction {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 900;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      animation: predictionPulse 2s infinite;
      text-shadow: 0 0 8px currentColor;
    }
    .prediction.tai {
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
      color: #fff;
      box-shadow: 0 0 15px rgba(255,107,107,0.6);
    }
    .prediction.xiu {
      background: linear-gradient(45deg, #4ecdc4, #44a08d);
      color: #fff;
      box-shadow: 0 0 15px rgba(78,205,196,0.6);
    }
    @keyframes predictionPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Percentage bars */
    .percentage-bar {
      display: flex;
      height: 8px;
      border-radius: 10px;
      overflow: hidden;
      margin: 6px 0;
      background: rgba(255,255,255,0.1);
    }
    .tai-bar {
      background: linear-gradient(90deg, #ff6b6b, #ff8e53);
      transition: width 0.5s ease;
    }
    .xiu-bar {
      background: linear-gradient(90deg, #4ecdc4, #44a08d);
      transition: width 0.5s ease;
    }

    /* Chip tr·∫°ng th√°i */
    .chip {
      display: inline-block; padding: 4px 10px; border-radius: 999px;
      font-size: 11px; font-weight: 800; margin-left: 8px;
      background: linear-gradient(90deg, #00ffea, #0077ff);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* N√∫t thu g·ªçn robot */
    #toggleRobot {
      position: absolute; right: -10px; top: -10px;
      width: 28px; height: 28px; border-radius: 50%;
      background: #111; border: 2px solid rgba(255,255,255,0.3);
      color: #fff; font-weight: 900; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 12px rgba(0,0,0,0.8);
      transition: all 0.2s;
    }
    #toggleRobot:hover {
      background: #333;
      transform: scale(1.1);
    }

    /* Li√™n h·ªá admin d∆∞·ªõi g√≥c */
    #contactFloating {
      position: fixed; right: 14px; bottom: 12px; z-index: 9998;
      background: rgba(0,0,0,0.55); border: 1px solid rgba(255,255,255,0.18);
      border-radius: 12px; padding: 8px 12px; font-weight: 800;
      box-shadow: 0 0 16px rgba(0,255,255,.35);
    }
    #contactFloating a {
      color: #ffcc00; text-decoration: none;
    }

    /* Loading spinner */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      #robotContainer {
        min-width: 280px;
        padding: 12px 15px;
        left: 10px;
      }
      #robotIcon { width: 60px; height: 60px; }
      #robotText .title { font-size: 15px; }
      #robotText .line { font-size: 13px; }
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginBox">
    <div id="loginPanel">
      <h2>üîê Nh·∫≠p Key Truy C·∫≠p</h2>
      <input type="password" id="password" placeholder="Nh·∫≠p Key..." />
      <button class="btn" id="loginBtn" onclick="checkKey()">ƒêƒÉng Nh·∫≠p</button>
      <button class="btn" id="buyKeyBtn" onclick="showPopup()">üõí Mua Key</button>
      <p id="msg"></p>
      <p id="adminContact">üì©Li√™n h·ªá Admin: <a href="https://t.me/doanhvip12" target="_blank">@doanhvip12</a></p>
    </div>
  </div>

  <!-- POPUP MUA KEY -->
  <div id="popup" onclick="if(event.target === this) hidePopup()">
    <div id="popupContent">
      <button onclick="hidePopup()" style="position:absolute; right:8px; top:8px; width:32px; height:32px; border-radius:50%; background:#ff4444; border:none; color:#fff; font-weight:bold; cursor:pointer; font-size:18px; z-index:10002; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(0,0,0,0.3);">√ó</button>
      <h3>üõí Ch·ªçn G√≥i Key Truy C·∫≠p</h3>
      <table id="packageTable">
        <tr onclick="selectPackage(this, '3 Ng√†y', 250000)">
          <td>üîë 3 Ng√†y</td><td style="color:#0ff; font-weight:bold; text-align:right;">250K</td>
        </tr>
        <tr onclick="selectPackage(this, '1 Tu·∫ßn', 300000)">
          <td>üîë 1 Tu·∫ßn</td><td style="color:#0ff; font-weight:bold; text-align:right;">300K</td>
        </tr>
        <tr onclick="selectPackage(this, '1 Th√°ng', 450000)">
          <td>üîë 1 Th√°ng</td><td style="color:#0ff; font-weight:bold; text-align:right;">450K</td>
        </tr>
        <tr onclick="selectPackage(this, 'Vƒ©nh Vi·ªÖn', 999000)">
          <td>üîë Vƒ©nh Vi·ªÖn</td><td style="color:#ff6666; font-weight:bold; text-align:right;">999K</td>
        </tr>
      </table>

      <div id="paymentBox" style="display:none;">
        <div id="packageName"></div>
        <p>üí≥ Qu√©t QR b·∫±ng Msb ƒë·ªÉ thanh to√°n:</p>
        <img id="qrImage" src="" alt="VietQR MB Bank"/>
        <p style="margin-top:10px;">
          <b>STK:</b> <span style="color:#0ff;">0865526750</span> (Msb)<br>
          <b>T√™n:</b> TRAN DUC DOANH<br>
          <b>N·ªôi dung:</b> Mua Key SunWin
        </p>
        <p id="countdown" style="color:#ff6666; font-weight: 800;"></p>
        <div style="display:flex; gap:10px; margin-top:15px;">
          <button onclick="copyBankInfo()" style="background:#007bff; color:#fff; padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; flex:1;">üìã Copy th√¥ng tin</button>
          <button onclick="hidePopup()" style="background:#dc3545; color:#fff; padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; flex:1;">‚ùå ƒê√≥ng</button>
        </div>
      </div>

      <!-- N√∫t mua key lu√¥n hi·ªÉn th·ªã -->
      <div style="margin-top:15px; text-align:center;">
        <button onclick="showPaymentOptions(); event.stopPropagation();" style="background:linear-gradient(90deg, #ff0080, #ff8c00); color:#fff; font-weight:800; font-size:18px; padding:15px 40px; border:none; border-radius:12px; cursor:pointer; box-shadow:0 4px 12px rgba(255,0,128,0.4); width:100%; transition:all 0.2s; animation:pulse 1.5s infinite;">
          üõí MUA KEY
        </button>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div id="mainContent">
    <!-- Loading screen -->
    <div id="gameLoading" style="
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 100; transition: opacity 0.3s; cursor: pointer;
    " onclick="hideGameLoading()">
      <div style="text-align: center;">
        <div style="
          width: 60px; height: 60px; border: 4px solid rgba(0,255,255,0.2);
          border-top: 4px solid #00ffff; border-radius: 50%;
          animation: spin 1s linear infinite; margin-bottom: 20px;
        "></div>
        <h3 style="color: #00ffff; margin: 10px 0;">üéÆ ƒêang t·∫£i SunWin...</h3>
        <p style="color: #ccc; font-size: 14px;">Vui l√≤ng ch·ªù trong gi√¢y l√°t</p>
        <p style="color: #ffcc00; font-size: 12px; margin-top: 15px; animation: pulse 2s infinite;">
          üëÜ Nh·∫•n ƒë·ªÉ b·ªè qua loading
        </p>
      </div>
    </div>

    <div id="gameContainer">
      <iframe id="gameFrame" src="https://web.sunwin.us" allow="camera; microphone; fullscreen; payment; geolocation" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox" style="background: #1a1a1a;" onload="hideGameLoading()" onerror="hideGameLoading()"></iframe>
    </div>

    <!-- ROBOT n·ªïi -->
    <div id="robotContainer">
      <button id="toggleRobot" title="Thu g·ªçn / m·ªü r·ªông">‚àí</button>
      <img id="robotIcon" src="https://cdn-icons-png.flaticon.com/512/4712/4712033.png" alt="bot" />
      <div id="robotText">
        <div class="title">ü§ñ SunWin AI Bot <span id="statusChip" class="chip">ƒêang k·∫øt n·ªëi‚Ä¶</span></div>
        <div id="predictionLine" class="line">‚è≥ Kh·ªüi ƒë·ªông h·ªá th·ªëng AI...</div>
        <div id="percentageLine" class="line"></div>
        <div id="infoLine" class="line"></div>
        <div id="metaLine" class="line" style="opacity:.7; font-size: 12px;"></div>
      </div>
    </div>

    <!-- Li√™n h·ªá admin g√≥c -->
    <div id="contactFloating">
      üì© <a href="https://t.me/doanhvip12" target="_blank">Li√™n h·ªá Admin @doanhvip12</a>
    </div>
  </div>

  <script>
    // ====== C·∫§U H√åNH API M·ªöI ======
    const API_URL = "https://toilavinhmaycays23.onrender.com/vinhmaycay";
    const BACKUP_API = "https://apiluck8-hknam.onrender.com/api/taixiu-md5";
    const ACCOUNT_NO = "0865526740";
    const ACCOUNT_NAME = "TRAN DUC DOANH";
    const FETCH_INTERVAL_MS = 2000; // g·ªçi API m·ªói 2 gi√¢y

    // ====== T·∫†O KEY THEO NG√ÄY ======
    function getTodayPassword() {
      const today = new Date();
      const dd = String(today.getDate()).padStart(2, "0");
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const yyyy = today.getFullYear();
      return `SUN${dd}${mm}${yyyy}`;
    }
    const KEY_TODAY = getTodayPassword();

    // ====== LOGIN ======
    function checkKey() {
      const pass = document.getElementById("password").value.trim();
      const msg = document.getElementById("msg");
      const adminContact = document.getElementById("adminContact");

      if (pass === KEY_TODAY) {
        msg.style.color = "lime";
        msg.textContent = "‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!";
        adminContact.style.display = "none";
        setTimeout(() => {
          document.getElementById("loginBox").style.display = "none";
          document.getElementById("mainContent").style.display = "block";
          autoHideLoading(); // B·∫Øt ƒë·∫ßu timer t·ª± ƒë·ªông ·∫©n loading
          startRobot();
        }, 700);
      } else {
        msg.style.color = "red";
        msg.textContent = "‚ùå Key kh√¥ng ƒë√∫ng!";
        adminContact.style.display = "block";
      }
    }

    // ====== POPUP MUA KEY ======
    function showPopup(){ document.getElementById("popup").style.display = "flex"; }
    function hidePopup(){ document.getElementById("popup").style.display = "none"; }

    function selectPackage(row, name, amount) {
      document.querySelectorAll("#packageTable tr").forEach(tr => tr.classList.remove("active"));
      row.classList.add("active");

      document.getElementById("paymentBox").style.display = "block";
      document.getElementById("packageName").innerText = `üëâ G√≥i b·∫°n ch·ªçn: ${name} - ${amount.toLocaleString()}ƒë`;

      const qrUrl = `https://img.vietqr.io/image/MB-${ACCOUNT_NO}-compact2.png?amount=${amount}&addInfo=Mua%20Key%20SunWin&accountName=${encodeURIComponent(ACCOUNT_NAME)}`;
      document.getElementById("qrImage").src = qrUrl;

      clearInterval(window.__countdownTimer);
      startCountdown(15 * 60);
    }

    function startCountdown(durationSec) {
      let t = durationSec;
      const el = document.getElementById("countdown");
      window.__countdownTimer = setInterval(() => {
        const m = Math.floor(t / 60);
        const s = String(t % 60).padStart(2, "0");
        el.textContent = `‚è≥ Vui l√≤ng thanh to√°n trong ${m}:${s}`;
        if (t <= 0) {
          clearInterval(window.__countdownTimer);
          el.textContent = "‚ùå H·∫øt th·ªùi gian! Vui l√≤ng ch·ªçn l·∫°i g√≥i.";
          document.getElementById("paymentBox").style.display = "none";
        }
        t--;
      }, 1000);
    }

    function copyBankInfo() {
      const text = `STK: ${ACCOUNT_NO}\nMB Bank\nT√™n: ${ACCOUNT_NAME}\nN·ªôi dung: Mua Key SunWin`;
      navigator.clipboard.writeText(text).then(() => alert("‚úÖ ƒê√£ copy th√¥ng tin thanh to√°n!"));
    }

    function showPaymentOptions() {
      // N·∫øu ch∆∞a ch·ªçn g√≥i n√†o, t·ª± ƒë·ªông ch·ªçn g√≥i ƒë·∫ßu ti√™n
      const activeRow = document.querySelector("#packageTable tr.active");
      if (!activeRow) {
        const firstRow = document.querySelector("#packageTable tr");
        if (firstRow) {
          selectPackage(firstRow, '3 Ng√†y', 250000);
        }
      } else {
        // N·∫øu ƒë√£ ch·ªçn g√≥i r·ªìi, ch·ªâ c·∫ßn hi·ªÉn th·ªã ph·∫ßn thanh to√°n
        document.getElementById("paymentBox").style.display = "block";
      }
    }

    // ====== ROBOT + API D·ª∞ ƒêO√ÅN M·ªöI ======
    let round = 0, fetchTimer = null, currentAPI = API_URL;

    function startRobot() {
      const statusChip = document.getElementById("statusChip");
      const predictionLine = document.getElementById("predictionLine");
      const percentageLine = document.getElementById("percentageLine");
      const infoLine = document.getElementById("infoLine");
      const metaLine = document.getElementById("metaLine");

      statusChip.textContent = "K·∫øt n·ªëi...";
      predictionLine.innerHTML = "üîå ƒêang k·∫øt n·ªëi API d·ª± ƒëo√°n...";
      percentageLine.innerHTML = "";
      infoLine.innerHTML = "";
      metaLine.innerHTML = "";

      // H√†m g·ªçi API v·ªõi fallback
      const callAPI = async () => {
        try {
          const response = await fetch(currentAPI, {
            method: "GET",
            mode: "cors",
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const data = await response.json();
          handleAPISuccess(data);

        } catch (err) {
          console.error("L·ªói API:", err);

          // Th·ª≠ API backup n·∫øu API ch√≠nh l·ªói
          if (currentAPI === API_URL) {
            currentAPI = BACKUP_API;
            console.log("Chuy·ªÉn sang API backup...");
            try {
              const backupResponse = await fetch(currentAPI, {
                method: "GET",
                mode: "cors"
              });
              const backupData = await backupResponse.json();
              handleAPISuccess(backupData, true);
            } catch (backupErr) {
              handleAPIError(backupErr);
            }
          } else {
            handleAPIError(err);
          }
        }
      };

      // X·ª≠ l√Ω khi API th√†nh c√¥ng
      const handleAPISuccess = (data, isBackup = false) => {
        // L∆∞u data ƒë·ªÉ s·ª≠ d·ª•ng cho c√°c function kh√°c
        window.lastAPIData = data;

        round++;
        statusChip.textContent = isBackup ? "Backup" : "Live";
        statusChip.style.background = isBackup ? "linear-gradient(90deg, #ff8c00, #ff0080)" : "linear-gradient(90deg, #00ffea, #0077ff)";

        console.log("API Response:", data); // Debug log

        const prediction = extractPrediction(data);
        predictionLine.innerHTML = renderPrediction(prediction, round);

        const percentages = extractPercentages(data);
        percentageLine.innerHTML = renderPercentages(percentages);

        const gameInfo = extractGameInfo(data);
        infoLine.innerHTML = renderGameInfo(gameInfo);

        metaLine.innerHTML = renderMeta(data, isBackup);
      };

      // X·ª≠ l√Ω khi API l·ªói
      const handleAPIError = (err) => {
        statusChip.textContent = "L·ªói";
        statusChip.style.background = "linear-gradient(90deg, #ff4444, #cc0000)";
        predictionLine.innerHTML = "‚ö†Ô∏è M·∫•t k·∫øt n·ªëi API";
        percentageLine.innerHTML = `<span style="color:#ff6666;">L·ªói: ${err.message || 'Kh√¥ng r√µ'}</span>`;
        infoLine.innerHTML = "üîÑ ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i...";
        metaLine.innerHTML = `<span style="opacity:.6;">Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c API server</span>`;
      };

      // G·ªçi API ngay l·∫≠p t·ª©c v√† l·∫∑p l·∫°i
      callAPI();
      fetchTimer = setInterval(callAPI, FETCH_INTERVAL_MS);

      // Thi·∫øt l·∫≠p drag v√† toggle
      enableDragWithinViewport(document.getElementById("robotContainer"));
      setupToggleRobot();
    }

    // ====== X·ª¨ L√ù D·ªÆ LI·ªÜU API ======
    function extractPrediction(data) {
      // Ph√¢n t√≠ch d·ª±a tr√™n k·∫øt qu·∫£ hi·ªán t·∫°i ƒë·ªÉ d·ª± ƒëo√°n phi√™n ti·∫øp theo
      const currentResult = data.Ket_qua || data.result;
      const currentTotal = data.Tong || data.total;
      const dice1 = data.Xuc_xac_1 || data.dice1;
      const dice2 = data.Xuc_xac_2 || data.dice2;
      const dice3 = data.Xuc_xac_3 || data.dice3;

      // Logic d·ª± ƒëo√°n ƒë∆°n gi·∫£n d·ª±a tr√™n pattern
      let nextPrediction = null;
      let confidence = 75; // confidence m·∫∑c ƒë·ªãnh
      let reasoning = "";

      if (currentTotal != null && !isNaN(currentTotal)) {
        const total = Number(currentTotal);

        // D·ª± ƒëo√°n ng∆∞·ª£c l·∫°i v·ªõi k·∫øt qu·∫£ hi·ªán t·∫°i (strategy contrarian)
        if (total >= 11) {
          nextPrediction = "X·ªàU";
          reasoning = `Phi√™n tr∆∞·ªõc: ${total} (${currentResult}), xu h∆∞·ªõng ƒë·∫£o chi·ªÅu`;
          confidence = Math.min(85, 60 + Math.abs(total - 10.5) * 3);
        } else {
          nextPrediction = "T√ÄI";
          reasoning = `Phi√™n tr∆∞·ªõc: ${total} (${currentResult}), xu h∆∞·ªõng ƒë·∫£o chi·ªÅu`;
          confidence = Math.min(85, 60 + Math.abs(total - 10.5) * 3);
        }

        // TƒÉng confidence n·∫øu c√≥ pattern ƒë·∫∑c bi·ªát
        if (dice1 && dice2 && dice3) {
          const dices = [dice1, dice2, dice3];
          const hasDouble = dices.some((d, i) => dices.indexOf(d) !== i);
          if (hasDouble) {
            confidence = Math.min(90, confidence + 10);
            reasoning += " + c√≥ s·ªëc ƒë√¥i";
          }
        }
      } else {
        nextPrediction = "T√ÄI"; // m·∫∑c ƒë·ªãnh
        reasoning = "Ph√¢n t√≠ch d·ªØ li·ªáu, xu h∆∞·ªõng tƒÉng";
        confidence = 65;
      }

      return {
        prediction: nextPrediction,
        confidence: Math.round(confidence),
        reasoning
      };
    }

    function extractPercentages(data) {
      // T√≠nh ph·∫ßn trƒÉm d·ª±a tr√™n d·ª± ƒëo√°n
      const pred = extractPrediction(data);
      const confidence = pred.confidence || 70;

      let taiPercent, xiuPercent;

      if (pred.prediction === "T√ÄI") {
        taiPercent = Math.max(55, confidence);
        xiuPercent = 100 - taiPercent;
      } else {
        xiuPercent = Math.max(55, confidence);
        taiPercent = 100 - xiuPercent;
      }

      return {
        tai: Math.round(taiPercent),
        xiu: Math.round(xiuPercent)
      };
    }

    function extractGameInfo(data) {
      // L·∫•y s·ªë phi√™n hi·ªán t·∫°i
      let phien = data.Phien || data.phien || data.round;
      if (phien != null) {
        phien = String(phien);
      }

      // Th·ªùi gian c√≤n l·∫°i (gi·∫£ ƒë·ªãnh)
      let timeRemain = Math.floor(Math.random() * 30) + 10; // 10-40s random

      // K·∫øt qu·∫£ phi√™n tr∆∞·ªõc
      const lastResult = data.Ket_qua || data.result;
      const lastTotal = data.Tong || data.total;
      const lastResultText = lastTotal ? `${lastResult} (${lastTotal})` : lastResult;

      // Win rate gi·∫£ ƒë·ªãnh
      let winRate = 78 + Math.floor(Math.random() * 15); // 78-92%

      return {
        phien,
        timeRemain,
        lastResult: lastResultText,
        winRate
      };
    }

    // ====== RENDER GI O DI·ªÜN ======
    function renderPrediction(pred, roundNo) {
      const { prediction, confidence, reasoning } = pred;

      // L·∫•y s·ªë phi√™n hi·ªán t·∫°i v√† t√≠nh phi√™n ti·∫øp theo
      const gameInfo = extractGameInfo(window.lastAPIData || {});
      const currentSession = gameInfo.phien || roundNo;
      const nextSession = gameInfo.phien ? (Number(gameInfo.phien) + 1) : (roundNo + 1);

      let html = `üéØ D·ª± ƒëo√°n phi√™n #${nextSession} ‚Äî `;

      if (prediction && prediction !== null && prediction !== undefined) {
        const predStr = String(prediction).toUpperCase();
        const isValid = ['TAI', 'T√ÄI', 'XIU', 'X·ªàU', 'OVER', 'UNDER', 'HIGH', 'LOW'].some(p =>
          predStr.includes(p)
        );

        if (isValid) {
          const isTai = ['TAI', 'T√ÄI', 'OVER', 'HIGH'].some(p => predStr.includes(p));

          html += `<span class="prediction ${isTai ? 'tai' : 'xiu'}">
            ${isTai ? 'üî• T√ÄI' : '‚ùÑÔ∏è X·ªàU'}
          </span>`;

          if (confidence && !isNaN(confidence)) {
            html += ` <span class="chip">Tin c·∫≠y: ${Math.round(confidence)}%</span>`;
          }
        } else {
          // Hi·ªÉn th·ªã d·ª± ƒëo√°n g·ªëc nh∆∞ng l√†m s·∫°ch k√Ω t·ª± l·∫°
          const cleanPred = String(prediction).replace(/[^\w\s√Ä-·ªπ]/g, '').trim();
          html += `D·ª± ƒëo√°n: <span class="strong">${cleanPred || 'ƒêang x·ª≠ l√Ω...'}</span>`;
        }
      } else {
        html += `<span style="color:#ffa500;">ƒêang ph√¢n t√≠ch...</span>`;
      }

      return html;
    }

    function renderPercentages(perc) {
      const { tai, xiu } = perc;

      if (tai != null && xiu != null) {
        return `
          <div style="display: flex; align-items: center; gap: 8px; margin: 8px 0;">
            <span style="font-weight: 800; color: #ff6b6b;">T√ÄI ${tai}%</span>
            <div class="percentage-bar" style="flex: 1;">
              <div class="tai-bar" style="width: ${tai}%;"></div>
              <div class="xiu-bar" style="width: ${xiu}%;"></div>
            </div>
            <span style="font-weight: 800; color: #4ecdc4;">X·ªàU ${xiu}%</span>
          </div>
        `;
      }

      return `<span style="color:#999;">ƒêang t√≠nh to√°n t·ª∑ l·ªá...</span>`;
    }

    function renderGameInfo(info) {
      const { phien, timeRemain, lastResult, winRate } = info;

      let html = "";

      if (phien && phien !== '') {
        html += `üìã Phi√™n: <span class="strong">${phien}</span>`;
      }

      if (timeRemain != null && timeRemain >= 0) {
        html += `${html ? ' ‚Ä¢ ' : ''}‚è±Ô∏è C√≤n: ${timeRemain}s`;
      }

      if (lastResult && String(lastResult).trim() !== '') {
        const cleanResult = String(lastResult).replace(/[^\w\s√Ä-·ªπ0-9]/g, '').trim();
        if (cleanResult) {
          html += `${html ? ' ‚Ä¢ ' : ''}üé≤ KQ: <span class="strong">${cleanResult}</span>`;
        }
      }

      if (winRate != null && winRate >= 0 && winRate <= 100) {
        html += `${html ? ' ‚Ä¢ ' : ''}üéØ Win: ${winRate}%`;
      }

      return html || "‚è≥ ƒêang ƒë·ªìng b·ªô th√¥ng tin game...";
    }

    function renderMeta(data, isBackup) {
      const apiStatus = isBackup ? "Backup API" : "Main API";
      const timestamp = new Date().toLocaleTimeString();

      try {
        // Ch·ªâ hi·ªÉn th·ªã th√¥ng tin c·∫ßn thi·∫øt, kh√¥ng spam keys
        const dataStatus = data.Phien ? `Phi√™n ${data.Phien}` : "D·ªØ li·ªáu OK";
        return `${apiStatus} ‚Ä¢ ${timestamp} ‚Ä¢ ${dataStatus}`;
      } catch(e) {
        return `${apiStatus} ‚Ä¢ ${timestamp} ‚Ä¢ K·∫øt n·ªëi ·ªïn ƒë·ªãnh`;
      }
    }

    // ====== DRAG & TOGGLE ======
    function enableDragWithinViewport(el){
      let startX=0, startY=0, dragging=false, offsetX=0, offsetY=0;

      // load v·ªã tr√≠
      try{
        const pos = JSON.parse(localStorage.getItem("robotPos"));
        if (pos && Number.isFinite(pos.x) && Number.isFinite(pos.y)) {
          el.style.left = pos.x + "px";
          el.style.top = pos.y + "px";
          el.style.transform = "translate(0,0)";
        }
      }catch{}

      function clamp(val, min, max){ return Math.max(min, Math.min(max, val)); }
      function bounds(){
        const vw = window.innerWidth, vh = window.innerHeight;
        const rect = el.getBoundingClientRect();
        return { minX: 6, minY: 6, maxX: vw - rect.width - 6, maxY: vh - rect.height - 6 };
      }

      // Mouse events
      el.addEventListener("mousedown", (e)=>{
        if (e.target && e.target.id === "toggleRobot") return;
        dragging = true; el.style.transition = "none";
        const rect = el.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
      });

      document.addEventListener("mousemove", (e)=>{
        if (!dragging) return;
        const b = bounds();
        const x = clamp(e.clientX - offsetX, b.minX, b.maxX);
        const y = clamp(e.clientY - offsetY, b.minY, b.maxY);
        el.style.left = x + "px";
        el.style.top = y + "px";
      });

      document.addEventListener("mouseup", ()=>{
        if (!dragging) return;
        dragging = false; el.style.transition = "all .2s";
        const rect = el.getBoundingClientRect();
        localStorage.setItem("robotPos", JSON.stringify({ x: rect.left, y: rect.top }));
      });

      // Touch events
      el.addEventListener("touchstart", (e)=>{
        if (e.target && e.target.id === "toggleRobot") return;
        dragging = true; el.style.transition = "none";
        const t = e.touches[0];
        const rect = el.getBoundingClientRect();
        offsetX = t.clientX - rect.left;
        offsetY = t.clientY - rect.top;
      }, {passive:true});

      window.addEventListener("touchmove", (e)=>{
        if (!dragging) return;
        const t = e.touches[0];
        const b = bounds();
        const x = clamp(t.clientX - offsetX, b.minX, b.maxX);
        const y = clamp(t.clientY - offsetY, b.minY, b.maxY);
        el.style.left = x + "px";
        el.style.top = y + "px";
      }, {passive:true});

      window.addEventListener("touchend", ()=>{
        if (!dragging) return;
        dragging = false; el.style.transition = "all .2s";
        const rect = el.getBoundingClientRect();
        localStorage.setItem("robotPos", JSON.stringify({ x: rect.left, y: rect.top }));
      });

      // Resize handler
      window.addEventListener("resize", ()=>{
        const rect = el.getBoundingClientRect();
        const b = bounds();
        const x = clamp(rect.left, b.minX, b.maxX);
        const y = clamp(rect.top, b.minY, b.maxY);
        el.style.left = x + "px";
        el.style.top = y + "px";
      });
    }

    function setupToggleRobot(){
      const btn = document.getElementById("toggleRobot");
      const text = document.getElementById("robotText");

      btn.onclick = ()=>{
        if (text.style.display === "none") {
          text.style.display = "block";
          btn.textContent = "‚àí";
          btn.title = "Thu g·ªçn";
        } else {
          text.style.display = "none";
          btn.textContent = "+";
          btn.title = "M·ªü r·ªông";
        }
      };
    }

    // ·∫®n loading screen khi game t·∫£i xong
    function hideGameLoading() {
      const loading = document.getElementById("gameLoading");
      if (loading) {
        setTimeout(() => {
          loading.style.opacity = "0";
          setTimeout(() => loading.style.display = "none", 300);
        }, 500); // Gi·∫£m th·ªùi gian ch·ªù xu·ªëng 0.5s
      }
    }

    // T·ª± ƒë·ªông ·∫©n loading sau 5s n·∫øu iframe kh√¥ng trigger onload
    function autoHideLoading() {
      setTimeout(() => {
        const loading = document.getElementById("gameLoading");
        if (loading && loading.style.display !== "none") {
          console.log("Auto hiding loading screen...");
          hideGameLoading();
        }
      }, 5000);
    }

    // Enter key cho login
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("password").addEventListener("keypress", (e) => {
        if (e.key === "Enter") checkKey();
      });
    });

  </script>
</body>
</html>
